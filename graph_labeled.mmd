flowchart TB
  start([__start__])
  router
  menu_lookup
  take_order
  confirm_order
  pos_submit
  chitchat
  error
  end_node([__end__])

  start --> router

  %% Router fan-out with labels
  router -- "stage == 'submit'" --> pos_submit
  router -- "intent in {ordering.lookup, ordering.more, ordering.lookup_refine}" --> menu_lookup
  router -- "intent == 'ordering.take'" --> take_order
  router -- "intent startswith 'confirm.'" --> confirm_order
  router -- "default" --> chitchat

  %% Workers -> end or error
  menu_lookup -- "no _error" --> end_node
  take_order -- "no _error" --> end_node
  confirm_order -- "no _error" --> end_node
  pos_submit -- "no _error" --> end_node
  chitchat -- "no _error" --> end_node

  menu_lookup -- "_error present" --> error
  take_order -- "_error present" --> error
  confirm_order -- "_error present" --> error
  pos_submit -- "_error present" --> error
  chitchat -- "_error present" --> error

  error --> end_node